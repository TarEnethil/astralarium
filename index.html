<!doctype html>
<html data-theme="dark" lang=en>
<head>
    <meta charset=utf-8>
    <title>Astralarium</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script src="fabric.min.js"></script>
</head>
<body>
    <nav class="container-fluid" id="nav">
        <ul>
            <li>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="19" height="19"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 15.968l4.247 2.377-.949-4.773 3.573-3.305-4.833-.573L12 5.275v10.693zm0 2.292l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928L12 18.26z"/></svg>
                <strong>Astralarium</strong>
            </li>
        </ul>
        <ul>
            <li>
                <a href="" id="mode-star-add" data-tooltip="Add a star by clicking">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-edit" data-tooltip="Edit a star by clicking on it">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M15.728 9.686l-1.414-1.414L5 17.586V19h1.414l9.314-9.314zm1.414-1.414l1.414-1.414-1.414-1.414-1.414 1.414 1.414 1.414zM7.242 21H3v-4.243L16.435 3.322a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414L7.243 21z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-line" data-tooltip="Draw lines between stars">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13.12 17.023l-4.199-2.29a4 4 0 1 1 0-5.465l4.2-2.29a4 4 0 1 1 .959 1.755l-4.2 2.29a4.008 4.008 0 0 1 0 1.954l4.199 2.29a4 4 0 1 1-.959 1.755zM6 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm11-6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-delete" data-tooltip="Delete stars or lines by clicking">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 4V2h10v2h5v2h-2v15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6H2V4h5zM6 6v14h12V6H6zm3 3h2v8H9V9zm4 0h2v8h-2V9z"/></svg>
                </a>
            </li>
        </ul>
        <ul id="star-control">
            <li>
                <input type="text" id="star-name" placeholder="Name" />
            </li>
            <li data-tooltip="Inner Color">
                <input type="color" id="star-inner-color" value="#ffffff" />
            </li>
            <li data-tooltip="Outer Color">
                <input type="color" id="star-border-color" value="#cccccc" />
            </li>
            <li data-tooltip="Size">
                <input type="range" min="2" max="20" id="star-size" />
            </li>
        </ul>
        <ul>
            <li>stars: <span id="counter-stars">0</span></li>
            <li>lines: <span id="counter-lines">0</span></li>
        </ul>
    </nav>

    <main class="container-fluid" id="main">
        <canvas id="star-map"></canvas>

        <fieldset id="save-load">
            <legend>Save / Load</legend>
            <textarea id="canvas-data"></textarea>
            <input type="button" id="save" value="save" />
            <input type="button" id="load" value="load" />
        </fieldset>
    </main>

    <script>
        (function() {
            var gid = function(id) { return document.getElementById(id); };
            var CANVAS_WIDTH = window.innerWidth;
            var CANVAS_HEIGHT = window.innerHeight - gid("nav").clientHeight;
            var PADDING = 20;
            var STARS = 2;
            var STARSIZES = [1, 2, 3, 4];
            var STAR_DEFAULT_SIZE = 4;
            var SZ_MAX = STARSIZES.length - 1;
            rando = fabric.util.getRandomInt;

            var _stars = new Map();
            var _lines = new Map();

            var _lastObject;
            var _pickingTo = false;

            var _mode;

            gid("mode-star-add").addEventListener("click", function(e) {
                e.preventDefault();
                document.activeElement.blur();
                enterAddMode();
            });

            gid("mode-star-edit").addEventListener("click", function(e) {
                e.preventDefault();
                document.activeElement.blur();
                enterEditMode();
            });

            gid("mode-star-line").addEventListener("click", function(e) {
                e.preventDefault();
                document.activeElement.blur();
                enterLineMode();
            });

            gid("mode-star-delete").addEventListener("click", function(e) {
                e.preventDefault();
                document.activeElement.blur();
                enterDeleteMode();
            });

            gid("save").addEventListener("click", function(e) {
                gid("canvas-data").value = JSON.stringify(canvas);
            });

            gid("load").addEventListener("click", function(e) {
                var data = gid("canvas-data").value;

                _stars = new Map();
                _lines = new Map();

                if (data != undefined && data != '') {
                    canvas.loadFromJSON(data);

                    canvas.getObjects("line").forEach(function(line) {
                        setupLine(line);
                    });

                    canvas.getObjects("circle").forEach(function(star) {
                        setupStar(star);

                        // for some reason, x{1,2} and y{1,2} are not correctly serialized
                        // as a workaround, we update the line coordinates here
                        updateLines(star);
                    });
                }
            });

            function updateCounters() {
                gid("counter-stars").innerHTML = _stars.size;
                gid("counter-lines").innerHTML = _lines.size;
            }

            function setMode(mode) {
                _mode = mode;

                gid("mode-star-add").classList.remove('active-mode');
                gid("mode-star-edit").classList.remove('active-mode');
                gid("mode-star-line").classList.remove('active-mode');
                gid("mode-star-delete").classList.remove('active-mode');

                gid("mode-star-" + mode).classList.add("active-mode");
            }

            function enterAddMode() {
                if (_mode != "add") {
                    setMode("add");
                    canvas.discardActiveObject();

                    gid("star-control").style.visibility = "visible";

                    _stars.forEach(function(star) {
                        star.selectable = false;
                        star.off({
                            "selected": onSelect,
                            "selected": deleteStarEvent,
                            "deselected": onDeselect,
                            "moving": onMove
                        });
                    });

                    _lines.forEach(function(line) {
                        line.evented = false;
                        line.selectable = false;
                        line.off({
                            "selected": deleteLineEvent
                        });
                    });

                    _pickingTo = false;
                    _lastObject = null;

                    canvas.on({
                        "mouse:up" : makeStarFromEvent
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterEditMode() {
                if (_mode != "edit") {
                    setMode("edit");
                    canvas.discardActiveObject();

                    gid("star-control").style.visibility = "hidden";

                    _stars.forEach(function(star) {
                        star.selectable = true;
                        star.off({
                            "selected": deleteStarEvent,
                        });
                        star.on({
                            "selected": onSelect,
                            "deselected": onDeselect,
                            "moving": onMove
                        });
                        star.lockMovementX = false;
                        star.lockMovementY = false;
                    });

                    _lines.forEach(function(line) {
                        line.evented = false;
                        line.selectable = false;
                        line.off({
                            "selected": deleteLineEvent
                        });
                    });

                    _pickingTo = false;
                    _lastObject = null;

                    canvas.off({
                        "mouse:up": makeStarFromEvent
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterLineMode() {
                if (_mode != "line") {
                    setMode("line");
                    canvas.discardActiveObject();

                    gid("star-control").style.visibility = "hidden";

                    _stars.forEach(function(star) {
                        star.selectable = true;
                        star.off({
                            "selected": onSelect,
                            "selected": deleteStarEvent,
                            "deselected": onDeselect,
                            "moving": onMove
                        });
                        star.on({
                            "selected": onSelect,
                            "deselected": onDeselect
                        });
                        star.lockMovementX = true;
                        star.lockMovementY = true;
                    });

                    _lines.forEach(function(line) {
                        line.evented = false;
                        line.selectable = false;
                        line.off({
                            "selected": deleteLineEvent
                        });
                    });

                    _pickingTo = false;
                    _lastObject = null;

                    canvas.off({
                        "mouse:up": makeStarFromEvent
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterDeleteMode() {
                if (_mode != "delete") {
                    setMode("delete");
                    canvas.discardActiveObject();

                    gid("star-control").style.visibility = "hidden";

                    _stars.forEach(function(star) {
                        star.selectable = true;
                        star.off({
                            "selected": onSelect,
                            "deselected": onDeselect,
                            "moving": onMove
                        });
                        star.on({
                            "selected": deleteStarEvent,
                        });
                    });

                    _lines.forEach(function(line) {
                        line.evented = true;
                        line.selectable = true;
                        line.on({
                            "selected": deleteLineEvent
                        });
                    });

                    _pickingTo = false;
                    _lastObject = null;

                    canvas.off({
                        "mouse:up": makeStarFromEvent
                    });

                    canvas.requestRenderAll();
                }
            }

            function uuidv4() {
              return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
              );
            }

            function onSelect(e) {
                if (_mode == "edit") {
                    observe(e.target, "star-name", "name")
                    observe(e.target, "star-inner-color", "fill");
                    observe(e.target, "star-border-color", "stroke");
                    observeInt(e.target, "star-size", "radius");
                    gid("star-control").style.visibility = "visible";
                }

                if (_mode == "line") {
                    if (_pickingTo) {
                        var line = makeLine(_lastObject, e.target);
                        canvas.add(line);
                        canvas.sendToBack(line);
                        canvas.renderAll();
                        _lastObject = null;
                        _pickingTo = false;
                        canvas.discardActiveObject();
                        canvas.requestRenderAll();
                    } else {
                        _pickingTo = true;
                        _lastObject = canvas.getActiveObject();
                    }
                }
            }

            function onDeselect(e) {
                gid("star-control").style.visibility = "hidden";
                unobserve("star-name");
                unobserve("star-inner-color");
                unobserve("star-border-color");
                unobserve("star-size");
            }

            function onMove(e) {
                updateLines(e.transform.target);
            }

            function deleteStarEvent(e) {
                var star = e.target;

                // copy so that we can remove values while iterating
                var lines_from_copy = star.lines_from.slice(0);
                lines_from_copy.forEach(function(uuid) {
                    deleteLine(uuid);
                });

                // copy so that we can remove values while iterating
                var lines_to_copy = star.lines_to.slice(0);
                lines_to_copy.forEach(function(uuid) {
                    deleteLine(uuid);
                });

                _stars.delete(star.uuid);
                canvas.remove(star);

                updateCounters();
            }

            function deleteLineEvent(e) {
                deleteLine(e.target.uuid);
                updateCounters();
            }

            function deleteLine(uuid) {
                var line = _lines.get(uuid);

                var idx = _stars.get(line.from).lines_from.indexOf(uuid);
                _stars.get(line.from).lines_from.splice(idx, 1);

                idx = _stars.get(line.to).lines_to.indexOf(uuid);
                _stars.get(line.to).lines_to.splice(idx, 1);

                _lines.delete(line.uuid);
                canvas.remove(line);
            }

            function updateLines(e) {
                var c = e.getCenterPoint();

                e.lines_from.forEach(function(uuid) {
                    _lines.get(uuid).set({ 'x1': c.x, 'y1': c.y });
                });

                e.lines_to.forEach(function(uuid) {
                    _lines.get(uuid).set({ 'x2': c.x, 'y2': c.y });
                });

                canvas.renderAll();
            }

            function observe(elem, id, property) {
                var el = document.getElementById(id);

                el.value = elem[property];
                el.oninput = function() {
                    elem.set(property, this.value);
                    elem.setCoords();
                    canvas.renderAll();
                }
            }

            function observeInt(elem, id, property) {
                var el = document.getElementById(id);

                el.value = elem[property];
                el.oninput = function() {
                    elem.set(property, parseInt(this.value, 10));
                    elem.setCoords();
                    canvas.renderAll();
                }
            }

            function unobserve(id) {
                document.getElementById(id).oninput = function(){};
            }

            function setupStar(star) {
                star.hasControls = false;
                star.selectable = false;

                star.toObject = (function(toObject) {
                  return function() {
                    return fabric.util.object.extend(toObject.call(this), {
                      name: this.name,
                      uuid: this.uuid,
                      lines_from: this.lines_from,
                      lines_to: this.lines_to
                    });
                  };
                })(star.toObject);

                _stars.set(star.uuid, star);
            }

            function makeStar(left, top, opts) {
                var size = ("size" in opts ? opts.size : STAR_DEFAULT_SIZE);
                var fill = ("fill" in opts ? opts.fill : "#ffffff");
                var stroke = ("stroke" in opts ? opts.stroke : "#cccccc");
                var name = ("name" in opts ? opts.name : "Unnamed star");

                var star = new fabric.Circle({
                    left: left,
                    top: top,
                    strokeWidth: 2,
                    radius: size,
                    fill: fill,
                    stroke: stroke
                });

                star.name = name;
                star.uuid = uuidv4();

                star.lines_from = [];
                star.lines_to = [];

                setupStar(star);

                updateCounters();

                return star;
            }

            function setupLine(line) {
                line.selectable = false;
                line.evented = false;

                line.toObject = (function(toObject) {
                  return function() {
                    return fabric.util.object.extend(toObject.call(this), {
                      uuid: this.uuid,
                      from: this.from,
                      to: this.to
                    });
                  };
                })(line.toObject);

                _lines.set(line.uuid, line);
            }

            function makeLine(from, to) {
                var c1 = from.getCenterPoint();
                var c2 = to.getCenterPoint();
                var coords = [c1.x, c1.y, c2.x, c2.y];
                var line = new fabric.Line(coords, {
                    stroke: "#ffffff",
                    strokeWidth: 1
                });

                line.uuid = uuidv4();

                line.from = from.uuid;
                line.to = to.uuid;

                from.lines_from.push(line.uuid);
                to.lines_to.push(line.uuid);

                setupLine(line);

                updateCounters();

                return line;
            }

            function makeRandomStar() {
                return makeStar(rando(PADDING, CANVAS_WIDTH-PADDING), rando(PADDING, CANVAS_HEIGHT-PADDING), { size: STARSIZES[rando(0, SZ_MAX)] });
            }

            function makeStarFromEvent(e) {
                if (e.target == null || e.target == undefined) {
                    var opts = {
                        size: gid("star-size").value,
                        fill: gid("star-inner-color").value,
                        stroke: gid("star-border-color").value,
                        name: gid("star-name").value
                    };

                    var x = e.absolutePointer.x - opts.size - 1;
                    var y = e.absolutePointer.y - opts.size - 1;

                    canvas.add(makeStar(x, y, opts));
                }
            }

            var canvas = this.__canvas = new fabric.Canvas('star-map', {
                width: CANVAS_WIDTH,
                height: CANVAS_HEIGHT,
                backgroundColor: '#000000',
                selection: false
            });

            for (var i = 0; i < STARS; i++) {
                canvas.add(makeRandomStar());
            }

            enterAddMode();
        })();
    </script>
</body>
</html>