<!doctype html>
<html data-theme="dark" lang=en>
<head>
    <meta charset=utf-8>
    <title>Astralarium</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script src="fabric.min.js"></script>
</head>
<body>
    <nav class="container-fluid" id="nav">
        <ul>
            <li>
                <!-- remixicon "ri-star-half-line" -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="19" height="19"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 15.968l4.247 2.377-.949-4.773 3.573-3.305-4.833-.573L12 5.275v10.693zm0 2.292l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928L12 18.26z"/></svg>
                <strong id="brand" data-tooltip="0 Stars, 0 Lines">Astralarium</strong>
            </li>
        </ul>
        <ul>
            <li>
                <a href="" id="button-canvas" data-tooltip="New or Load Map">
                    <!-- remixicon "ri-file-2-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 8l6.003-6h10.995C20.55 2 21 2.455 21 2.992v18.016a.993.993 0 0 1-.993.992H3.993A1 1 0 0 1 3 20.993V8zm7-4v5H5v11h14V4h-9z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="button-save" data-tooltip="Save or Export Map">
                    <!-- remixicon "ri-save-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/>
                    <path d="M7 19v-6h10v6h2V7.828L16.172 5H5v14h2zM4 3h13l4 4v13a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm5 12v4h6v-4H9z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="button-background" data-tooltip="Choose Canvas Background">
                    <!-- remixicon "ri-image-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M4.828 21l-.02.02-.021-.02H2.992A.993.993 0 0 1 2 20.007V3.993A1 1 0 0 1 2.992 3h18.016c.548 0 .992.445.992.993v16.014a1 1 0 0 1-.992.993H4.828zM20 15V5H4v14L14 9l6 6zm0 2.828l-6-6L6.828 19H20v-1.172zM8 11a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
                </a>
            </li>
            <li></li>
            <li></li>
            <li>
                <a href="" id="mode-star-add" data-tooltip="Add a star by clicking">
                    <!-- remixicon "ri-add-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-edit" data-tooltip="Edit a star by clicking on it">
                    <!-- remixicon "ri-pencil-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M15.728 9.686l-1.414-1.414L5 17.586V19h1.414l9.314-9.314zm1.414-1.414l1.414-1.414-1.414-1.414-1.414 1.414 1.414 1.414zM7.242 21H3v-4.243L16.435 3.322a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414L7.243 21z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-line" data-tooltip="Draw lines between stars">
                    <!-- remixicon "ri-share-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13.12 17.023l-4.199-2.29a4 4 0 1 1 0-5.465l4.2-2.29a4 4 0 1 1 .959 1.755l-4.2 2.29a4.008 4.008 0 0 1 0 1.954l4.199 2.29a4 4 0 1 1-.959 1.755zM6 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm11-6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                </a>
            </li>
            <li>
                <a href="" id="mode-star-delete" data-tooltip="Delete stars or lines by clicking">
                    <!-- remixicon "ri-delete-bin-6-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 4V2h10v2h5v2h-2v15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6H2V4h5zM6 6v14h12V6H6zm3 3h2v8H9V9zm4 0h2v8h-2V9z"/></svg>
                </a>
            </li>
        </ul>
        <ul id="star-control">
            <li>
                <input type="text" id="star-name" placeholder="Name" />
            </li>
            <li data-tooltip="Inner Color">
                <input type="color" id="star-inner-color" value="#ffffff" />
            </li>
            <li data-tooltip="Outer Color">
                <input type="color" id="star-border-color" value="#cccccc" />
            </li>
            <li data-tooltip="Size">
                <input type="range" min="2" max="20" id="star-size" />
            </li>
        </ul>
        <ul>
            <li>
                <a href="https://github.com/tarenethil/astralarium">
                    <!-- remixicon "ri-github-fill" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 2C6.475 2 2 6.475 2 12a9.994 9.994 0 0 0 6.838 9.488c.5.087.687-.213.687-.476 0-.237-.013-1.024-.013-1.862-2.512.463-3.162-.612-3.362-1.175-.113-.288-.6-1.175-1.025-1.413-.35-.187-.85-.65-.013-.662.788-.013 1.35.725 1.538 1.025.9 1.512 2.338 1.087 2.912.825.088-.65.35-1.087.638-1.337-2.225-.25-4.55-1.113-4.55-4.938 0-1.088.387-1.987 1.025-2.688-.1-.25-.45-1.275.1-2.65 0 0 .837-.262 2.75 1.026a9.28 9.28 0 0 1 2.5-.338c.85 0 1.7.112 2.5.337 1.912-1.3 2.75-1.024 2.75-1.024.55 1.375.2 2.4.1 2.65.637.7 1.025 1.587 1.025 2.687 0 3.838-2.337 4.688-4.562 4.938.362.312.675.912.675 1.85 0 1.337-.013 2.412-.013 2.75 0 .262.188.574.688.474A10.016 10.016 0 0 0 22 12c0-5.525-4.475-10-10-10z"/></svg>
                </a>
            </li>
        </ul>
    </nav>

    <main class="container-fluid" id="main">
        <canvas id="star-map"></canvas>

        <article id="popup-canvas" class="popup">
            <header>
                New or Load Canvas

                <a href="" id="close-canvas-popup" class="close-button">
                    <!-- remixicon "ri-close-circle-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"/></svg>
                </a>
            </header>

            <details open>
                <summary>New Canvas</summary>
                TODO
            </details>

            <details>
                <summary>Load Canvas</summary>
                TODO
            </details>
        </article>

        <article id="popup-save" class="popup">
            <header>
                Export or Save Canvas

                <a href="" id="close-save-popup" class="close-button">
                    <!-- remixicon "ri-close-circle-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"/></svg>
                </a>
            </header>

            <details open>
                <summary>Export Canvas</summary>

                <button id="export-png">Export as PNG</button>
                <button id="export-svg">Export as SVG (experimental)</button>
            </details>

            <details open>
                <summary>Save Canvas</summary>

                <button id="export-json" data-tooltip="Can (maybe) be loaded later">Save as JSON (experimental)</button>
            </details>
        </article>

        <article id="popup-background" class="popup">
            <header>
                Choose a Background Image

                <a href="" id="close-background-popup" class="close-button">
                    <!-- remixicon "ri-close-circle-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-9.414l2.828-2.829 1.415 1.415L13.414 12l2.829 2.828-1.415 1.415L12 13.414l-2.828 2.829-1.415-1.415L10.586 12 7.757 9.172l1.415-1.415L12 10.586z"/></svg>
                </a>
            </header>

            <div data-tooltip="Stretch Image to Canvas" class="inline-form">
                <input type="checkbox" id="background-stretch" name="background-stretch" role="switch">
                <label for="background-stretch">
                     Stretch
                </label>
            </div>

            <details open>
                <summary>From URL</summary>

                <input type="text" id="background-url" placeholder="http(s)://..." />
                <button id="button-url-background">Load Image</button>
            </details>

            <details>
                <summary id="premade-background-spinner">Premade (stretch recommended)</summary>

                <div class="grid">
                    <img src="https://tarenethil.github.io/astralarium/img/thumb/pexels-kai.jpg" class="background-gallery-image" />
                    <img src="https://tarenethil.github.io/astralarium/img/thumb/pexels-kai.jpg" class="background-gallery-image" />
                </div>
            </details>

            <footer>
                <button id="button-delete-background" class="secondary">
                    <!-- remixicon "ri-delete-bin-6-line" -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 4V2h10v2h5v2h-2v15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6H2V4h5zM6 6v14h12V6H6zm3 3h2v8H9V9zm4 0h2v8h-2V9z"/></svg>
                    Delete Background
                </button>
            </footer>
        </article>

        <fieldset id="save-load">
            <legend>Save / Load</legend>
            <textarea id="canvas-data"></textarea>
            <input type="button" id="save" value="save" />
            <input type="button" id="load" value="load" />
        </fieldset>
    </main>

    <script>
        (function() {
            var gid = function(id) { return document.getElementById(id); };
            var CANVAS_WIDTH = window.innerWidth;
            var CANVAS_HEIGHT = window.innerHeight - gid("nav").clientHeight;
            var PADDING = 20;
            var STARS = 2;
            var STARSIZES = [1, 2, 3, 4];
            var STAR_DEFAULT_SIZE = 4;
            var SZ_MAX = STARSIZES.length - 1;
            rando = fabric.util.getRandomInt;

            var _stars = new Map();
            var _lines = new Map();

            var _lastObject;
            var _pickingTo = false;

            var _mode;

            gid("mode-star-add").addEventListener("click", e => {
                e.preventDefault();
                document.activeElement.blur();
                enterAddMode();
            });

            gid("mode-star-edit").addEventListener("click", e => {
                e.preventDefault();
                document.activeElement.blur();
                enterEditMode();
            });

            gid("mode-star-line").addEventListener("click", e => {
                e.preventDefault();
                document.activeElement.blur();
                enterLineMode();
            });

            gid("mode-star-delete").addEventListener("click", e => {
                e.preventDefault();
                document.activeElement.blur();
                enterDeleteMode();
            });

            function closePopup(id) {
                gid("popup-" + id).style.display = "none";
            }

            function openPopup(id) {
                resetMode();

                closePopup("canvas");
                closePopup("save");
                closePopup("background");

                gid("popup-" + id).style.display = "block";

                document.activeElement.blur();
            }

            gid("button-canvas").addEventListener("click", e => {
                e.preventDefault();
                openPopup("canvas");
            });

            function triggerDownload(name, url) {
                var link = document.createElement('a');
                link.download = name;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            gid("export-png").addEventListener("click", e => {
                var dataURL = canvas.toDataURL({
                     width: canvas.width,
                     height: canvas.height,
                     left: 0,
                     top: 0,
                     format: 'png'
                });

                triggerDownload("image.png", dataURL);
            });

            gid("export-svg").addEventListener("click", e => {
                var dataURL = canvas.toSVG({
                     width: canvas.width,
                     height: canvas.height
                });

                var blob = new Blob([dataURL], {type: "image/svg+xml;charset=utf-8"});
                var localURL = URL.createObjectURL(blob);

                triggerDownload("image.svg", localURL);
            });

            gid("export-json").addEventListener("click", e => {
                var data =  JSON.stringify(canvas);

                var blob = new Blob([data], {type: "application/json;charset=utf-8"});
                var localURL = URL.createObjectURL(blob);

                triggerDownload("stars.json", localURL);
            });

            gid("close-canvas-popup").addEventListener("click", e => {
                e.preventDefault();
                closePopup("canvas");
            });

            gid("button-save").addEventListener("click", e => {
                e.preventDefault();
                openPopup("save");
            });

            gid("close-save-popup").addEventListener("click", e => {
                e.preventDefault();
                closePopup("save");
            });

            gid("button-background").addEventListener("click", e => {
                e.preventDefault();
                openPopup("background");
            });

            gid("button-delete-background").addEventListener("click", e => {
                e.preventDefault();

                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));

                gid("popup-background").style.display = "none";
            });

            gid("close-background-popup").addEventListener("click", e => {
                e.preventDefault();
                closePopup("background");
            });

            gid("button-url-background").addEventListener("click", e => {
                var v = gid("background-url").value;

                if (v && v != "") {
                    loadBackground(v, "button-url-background");
                }
            });

            var images = document.getElementsByClassName("background-gallery-image");
            for (var i = 0; i < images.length; i++) {
                var url = images[i].src.replace(/\/thumb/, "");
                images[i].addEventListener("click", e => {
                    loadBackground(url, "premade-background-spinner");
                });
            }

            gid("save").addEventListener("click", e => {
                gid("canvas-data").value = JSON.stringify(canvas);
            });

            gid("load").addEventListener("click", e => {
                var data = gid("canvas-data").value;

                _stars = new Map();
                _lines = new Map();

                if (data != undefined && data != '') {
                    canvas.loadFromJSON(data);

                    canvas.getObjects("line").forEach(line => {
                        setupLine(line);
                    });

                    canvas.getObjects("circle").forEach(star => {
                        setupStar(star);

                        // for some reason, x{1,2} and y{1,2} are not correctly serialized
                        // as a workaround, we update the line coordinates here
                        updateLines(star);
                    });
                }
            });

            function updateCounters() {
                gid("brand").setAttribute("data-tooltip", _stars.size + " Stars, " + _lines.size + " Lines");
            }

            function loadBackground(url, button_id) {
                var b = gid(button_id);
                b.setAttribute("aria-busy", true);

                fabric.Image.fromURL(url, imgObj => {
                    var opts = { opacity: 1,
                                 originX: 'left',
                                 originY: 'top',
                                 crossOrigin: true };

                    if (gid("background-stretch").checked) {
                        opts.scaleX = canvas.width / imgObj.width;
                        opts.scaleY = canvas.height / imgObj.height;
                    }

                    canvas.setBackgroundImage(imgObj, canvas.renderAll.bind(canvas), opts);

                    b.removeAttribute("aria-busy");
                    gid("popup-background").style.display = "none";
                }, { crossOrigin: true });
            }

            function resetMode() {
                _mode = null;

                gid("mode-star-add").classList.remove('active-mode');
                gid("mode-star-edit").classList.remove('active-mode');
                gid("mode-star-line").classList.remove('active-mode');
                gid("mode-star-delete").classList.remove('active-mode');

                canvas.discardActiveObject();

                gid("star-control").style.visibility = "hidden";

                _stars.forEach(star => {
                    star.selectable = false;
                    star.off({
                        "selected": onSelect,
                        "deselected": onDeselect,
                        "moving": onMove
                    });
                    // off() does not seem to work with the same key twice?
                    star.off({
                        "selected": deleteStarEvent
                    });
                    star.lockMovementX = false;
                    star.lockMovementY = false;
                });

                _lines.forEach(line => {
                    line.evented = false;
                    line.selectable = false;
                    line.off({
                        "selected": deleteLineEvent
                    });
                });

                _pickingTo = false;
                _lastObject = null;

                canvas.off({
                    "mouse:up" : makeStarFromEvent
                });
            }

            function setMode(mode) {
                _mode = mode;
                gid("mode-star-" + mode).classList.add("active-mode");
            }

            function enterAddMode() {
                if (_mode != "add") {
                    resetMode();
                    setMode("add");

                    gid("star-control").style.visibility = "visible";

                    canvas.on({
                        "mouse:up" : makeStarFromEvent
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterEditMode() {
                if (_mode != "edit") {
                    resetMode();
                    setMode("edit");

                    _stars.forEach(star => {
                        star.selectable = true;
                        star.on({
                            "selected": onSelect,
                            "deselected": onDeselect,
                            "moving": onMove
                        });
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterLineMode() {
                if (_mode != "line") {
                    resetMode();
                    setMode("line");

                    _stars.forEach(star => {
                        star.selectable = true;
                        star.on({
                            "selected": onSelect,
                            "deselected": onDeselect
                        });
                        star.lockMovementX = true;
                        star.lockMovementY = true;
                    });

                    canvas.requestRenderAll();
                }
            }

            function enterDeleteMode() {
                if (_mode != "delete") {
                    resetMode();
                    setMode("delete");

                    _stars.forEach(star => {
                        star.selectable = true;
                        star.on({
                            "selected": deleteStarEvent,
                        });
                    });

                    _lines.forEach(line => {
                        line.evented = true;
                        line.selectable = true;
                        line.on({
                            "selected": deleteLineEvent
                        });
                    });

                    canvas.requestRenderAll();
                }
            }

            function uuidv4() {
              return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
              );
            }

            function onSelect(e) {
                if (_mode == "edit") {
                    observe(e.target, "star-name", "name")
                    observe(e.target, "star-inner-color", "fill");
                    observe(e.target, "star-border-color", "stroke");
                    observeInt(e.target, "star-size", "radius");
                    gid("star-control").style.visibility = "visible";
                }

                if (_mode == "line") {
                    if (_pickingTo) {
                        var line = makeLine(_lastObject, e.target);
                        canvas.add(line);
                        canvas.sendToBack(line);
                        canvas.renderAll();
                        _lastObject = null;
                        _pickingTo = false;
                        canvas.discardActiveObject();
                        canvas.requestRenderAll();
                    } else {
                        _pickingTo = true;
                        _lastObject = canvas.getActiveObject();
                    }
                }
            }

            function onDeselect(e) {
                gid("star-control").style.visibility = "hidden";
                unobserve("star-name");
                unobserve("star-inner-color");
                unobserve("star-border-color");
                unobserve("star-size");
            }

            function onMove(e) {
                updateLines(e.transform.target);
            }

            function deleteStarEvent(e) {
                var star = e.target;

                // copy so that we can remove values while iterating
                var lines_from_copy = star.lines_from.slice(0);
                lines_from_copy.forEach(uuid => {
                    deleteLine(uuid);
                });

                // copy so that we can remove values while iterating
                var lines_to_copy = star.lines_to.slice(0);
                lines_to_copy.forEach(uuid => {
                    deleteLine(uuid);
                });

                _stars.delete(star.uuid);
                canvas.remove(star);

                updateCounters();
            }

            function deleteLineEvent(e) {
                deleteLine(e.target.uuid);
                updateCounters();
            }

            function deleteLine(uuid) {
                var line = _lines.get(uuid);

                var idx = _stars.get(line.from).lines_from.indexOf(uuid);
                _stars.get(line.from).lines_from.splice(idx, 1);

                idx = _stars.get(line.to).lines_to.indexOf(uuid);
                _stars.get(line.to).lines_to.splice(idx, 1);

                _lines.delete(line.uuid);
                canvas.remove(line);
            }

            function updateLines(e) {
                var c = e.getCenterPoint();

                e.lines_from.forEach(uuid => {
                    _lines.get(uuid).set({ 'x1': c.x, 'y1': c.y });
                });

                e.lines_to.forEach(uuid => {
                    _lines.get(uuid).set({ 'x2': c.x, 'y2': c.y });
                });

                canvas.renderAll();
            }

            function observe(elem, id, property) {
                var el = document.getElementById(id);

                el.value = elem[property];
                el.oninput = function() {
                    elem.set(property, this.value);
                    elem.setCoords();
                    canvas.renderAll();
                }
            }

            function observeInt(elem, id, property) {
                var el = document.getElementById(id);

                el.value = elem[property];
                el.oninput = function() {
                    elem.set(property, parseInt(this.value, 10));
                    elem.setCoords();
                    canvas.renderAll();
                }
            }

            function unobserve(id) {
                document.getElementById(id).oninput = function(){};
            }

            function setupStar(star) {
                star.hasControls = false;
                star.selectable = false;

                star.toObject = (function(toObject) {
                  return function() {
                    return fabric.util.object.extend(toObject.call(this), {
                      name: this.name,
                      uuid: this.uuid,
                      lines_from: this.lines_from,
                      lines_to: this.lines_to
                    });
                  };
                })(star.toObject);

                _stars.set(star.uuid, star);
            }

            function makeStar(left, top, opts) {
                var size = ("size" in opts ? opts.size : STAR_DEFAULT_SIZE);
                var fill = ("fill" in opts ? opts.fill : "#ffffff");
                var stroke = ("stroke" in opts ? opts.stroke : "#cccccc");
                var name = ("name" in opts ? opts.name : "Unnamed star");

                // string might be empty
                if (!name) {
                    name = "Unnamed star";
                }

                var star = new fabric.Circle({
                    left: left,
                    top: top,
                    strokeWidth: 2,
                    radius: size,
                    fill: fill,
                    stroke: stroke
                });

                star.name = name;
                star.uuid = uuidv4();

                star.lines_from = [];
                star.lines_to = [];

                setupStar(star);

                updateCounters();

                return star;
            }

            function setupLine(line) {
                line.selectable = false;
                line.evented = false;

                line.toObject = (function(toObject) {
                  return function() {
                    return fabric.util.object.extend(toObject.call(this), {
                      uuid: this.uuid,
                      from: this.from,
                      to: this.to
                    });
                  };
                })(line.toObject);

                _lines.set(line.uuid, line);
            }

            function makeLine(from, to) {
                var c1 = from.getCenterPoint();
                var c2 = to.getCenterPoint();
                var coords = [c1.x, c1.y, c2.x, c2.y];
                var line = new fabric.Line(coords, {
                    stroke: "#ffffff",
                    strokeWidth: 1
                });

                line.uuid = uuidv4();

                line.from = from.uuid;
                line.to = to.uuid;

                from.lines_from.push(line.uuid);
                to.lines_to.push(line.uuid);

                setupLine(line);

                updateCounters();

                return line;
            }

            function makeRandomStar() {
                return makeStar(rando(PADDING, CANVAS_WIDTH-PADDING), rando(PADDING, CANVAS_HEIGHT-PADDING), { size: STARSIZES[rando(0, SZ_MAX)] });
            }

            function makeStarFromEvent(e) {
                if (e.target == null || e.target == undefined) {
                    var opts = {
                        size: gid("star-size").value,
                        fill: gid("star-inner-color").value,
                        stroke: gid("star-border-color").value,
                        name: gid("star-name").value
                    };

                    var x = e.absolutePointer.x - opts.size - 1;
                    var y = e.absolutePointer.y - opts.size - 1;

                    canvas.add(makeStar(x, y, opts));
                }
            }

            var canvas = this.__canvas = new fabric.Canvas('star-map', {
                width: CANVAS_WIDTH,
                height: CANVAS_HEIGHT,
                backgroundColor: '#000000',
                selection: false
            });

            for (var i = 0; i < STARS; i++) {
                canvas.add(makeRandomStar());
            }

            enterAddMode();
        })();
    </script>
</body>
</html>